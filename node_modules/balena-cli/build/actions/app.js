// Generated by CoffeeScript 1.12.7

/*
Copyright 2016-2017 Balena

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

   http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
 */
var commandOptions;

commandOptions = require('./command-options');

exports.create = {
  signature: 'app create <name>',
  description: 'create an application',
  help: 'Use this command to create a new balena application.\n\nYou can specify the application device type with the `--type` option.\nOtherwise, an interactive dropdown will be shown for you to select from.\n\nYou can see a list of supported device types with\n\n	$ balena devices supported\n\nExamples:\n\n	$ balena app create MyApp\n	$ balena app create MyApp --type raspberry-pi',
  options: [
    {
      signature: 'type',
      parameter: 'type',
      description: 'application device type (Check available types with `balena devices supported`)',
      alias: 't'
    }
  ],
  permission: 'user',
  action: function(params, options, done) {
    var balena, patterns;
    balena = require('balena-sdk').fromSharedOptions();
    patterns = require('../utils/patterns');
    return balena.models.application.has(params.name).then(function(hasApplication) {
      if (hasApplication) {
        return patterns.exitWithExpectedError('You already have an application with that name!');
      }
    }).then(function() {
      return options.type || patterns.selectDeviceType();
    }).then(function(deviceType) {
      return balena.models.application.create({
        name: params.name,
        deviceType: deviceType
      });
    }).then(function(application) {
      return console.info("Application created: " + application.app_name + " (" + application.device_type + ", id " + application.id + ")");
    }).nodeify(done);
  }
};

exports.list = {
  signature: 'apps',
  description: 'list all applications',
  help: 'Use this command to list all your applications.\n\nNotice this command only shows the most important bits of information for each app.\nIf you want detailed information, use balena app <name> instead.\n\nExamples:\n\n	$ balena apps',
  permission: 'user',
  primary: true,
  action: function(params, options, done) {
    var balena, visuals;
    balena = require('balena-sdk').fromSharedOptions();
    visuals = require('resin-cli-visuals');
    return balena.models.application.getAll().then(function(applications) {
      return console.log(visuals.table.horizontal(applications, ['id', 'app_name', 'device_type', 'online_devices', 'devices_length']));
    }).nodeify(done);
  }
};

exports.info = {
  signature: 'app <name>',
  description: 'list a single application',
  help: 'Use this command to show detailed information for a single application.\n\nExamples:\n\n	$ balena app MyApp',
  permission: 'user',
  primary: true,
  action: function(params, options, done) {
    var balena, visuals;
    balena = require('balena-sdk').fromSharedOptions();
    visuals = require('resin-cli-visuals');
    return balena.models.application.get(params.name).then(function(application) {
      return console.log(visuals.table.vertical(application, ["$" + application.app_name + "$", 'id', 'device_type', 'git_repository', 'commit']));
    }).nodeify(done);
  }
};

exports.restart = {
  signature: 'app restart <name>',
  description: 'restart an application',
  help: 'Use this command to restart all devices that belongs to a certain application.\n\nExamples:\n\n	$ balena app restart MyApp',
  permission: 'user',
  action: function(params, options, done) {
    var balena;
    balena = require('balena-sdk').fromSharedOptions();
    return balena.models.application.restart(params.name).nodeify(done);
  }
};

exports.remove = {
  signature: 'app rm <name>',
  description: 'remove an application',
  help: 'Use this command to remove a balena application.\n\nNotice this command asks for confirmation interactively.\nYou can avoid this by passing the `--yes` boolean option.\n\nExamples:\n\n	$ balena app rm MyApp\n	$ balena app rm MyApp --yes',
  options: [commandOptions.yes],
  permission: 'user',
  action: function(params, options, done) {
    var balena, patterns;
    balena = require('balena-sdk').fromSharedOptions();
    patterns = require('../utils/patterns');
    return patterns.confirm(options.yes, 'Are you sure you want to delete the application?').then(function() {
      return balena.models.application.remove(params.name);
    }).nodeify(done);
  }
};

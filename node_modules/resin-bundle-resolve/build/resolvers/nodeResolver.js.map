{"version":3,"sources":["../src/resolvers/nodeResolver.ts"],"names":[],"mappings":"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","file":"nodeResolver.js","sourcesContent":["import * as Promise from 'bluebird';\n\nimport * as _ from 'lodash';\nimport * as request from 'request';\nimport * as semver from 'semver';\n\nconst getAsync = Promise.promisify(request.get);\n\nimport * as BluebirdLRU from 'bluebird-lru-cache';\n\nimport { Bundle, FileInfo, Resolver } from '../resolver';\n\n// Used below for when no engine version can be determined.\nconst DEFAULT_NODE = '0.10.22';\n\nconst versionTest = RegExp.prototype.test.bind(/^[0-9]+\\.[0-9]+\\.[0-9]+$/);\nconst versionCache: {\n\tget: (deviceType: string) => Promise<string[]>;\n} = new BluebirdLRU({\n\tmaxAge: 3600 * 1000, // 1 hour\n\tfetchFn: (deviceType: string) => {\n\t\tconst get = (prev: string[], url: string): Promise<string[]> => {\n\t\t\treturn getAsync({\n\t\t\t\turl,\n\t\t\t\tjson: true,\n\t\t\t})\n\t\t\t.get('body')\n\t\t\t.then((res: { results: Array<{ name: string }>; next?: string }) => {\n\t\t\t\t// explicit casting here, as typescript interprets the following statement as {}[]\n\t\t\t\tconst curr: string[] = _(res.results).map('name').filter(versionTest).value() as string[];\n\t\t\t\tconst tags = prev.concat(curr);\n\n\t\t\t\tif (res.next != null) {\n\t\t\t\t\treturn get(tags, res.next);\n\t\t\t\t} else {\n\t\t\t\t\treturn tags;\n\t\t\t\t}\n\t\t\t});\n\t\t};\n\n\t\t// 100 is the max page size\n\t\treturn get(\n\t\t\t[],\n\t\t\t`https://hub.docker.com/v2/repositories/resin/${deviceType}-node/tags/?page_size=100`,\n\t\t);\n\t},\n});\n\nexport default class NodeResolver implements Resolver {\n\tpublic priority = 0;\n\tpublic name = 'NodeJS';\n\n\tprivate packageJsonContent?: Buffer;\n\tprivate hasScripts = false;\n\n\tpublic entry(file: FileInfo): void {\n\t\tif (file.name === 'package.json') {\n\t\t\tthis.packageJsonContent = file.contents;\n\t\t} else if (file.name === 'wscript' || _.endsWith(file.name, '.gyp')) {\n\t\t\tthis.hasScripts = true;\n\t\t}\n\t}\n\n\tpublic isSatisfied(_bundle: Bundle): boolean {\n\t\treturn this.packageJsonContent != null;\n\t}\n\n\tpublic resolve(bundle: Bundle): Promise<FileInfo[]> {\n\t\t// Generate a dockerfile which will run the file\n\t\t// Use latest node base image. Don't use the slim image just in case\n\t\t// TODO: Find out which apt-get packages are installed mostly with node\n\t\t// base images.\n\t\treturn Promise.try(() => JSON.parse(this.packageJsonContent!.toString()))\n\t\t\t.catch((e: Error) => {\n\t\t\t\tthrow new Error(`package.json: ${e.message}`);\n\t\t\t})\n\t\t\t.then(packageJson => {\n\t\t\t\tif (!_.isObject(packageJson)) {\n\t\t\t\t\tthrow new Error('package.json: must be a JSON object');\n\t\t\t\t}\n\n\t\t\t\tthis.hasScripts =\n\t\t\t\t\tthis.hasScripts ||\n\t\t\t\t\t_(packageJson.scripts)\n\t\t\t\t\t\t.pick('preinstall', 'install', 'postinstall')\n\t\t\t\t\t\t.size() > 0;\n\n\t\t\t\tconst nodeEngine = _.get(packageJson, 'engines.node');\n\t\t\t\tif (nodeEngine != null && !_.isString(nodeEngine)) {\n\t\t\t\t\tthrow new Error(\n\t\t\t\t\t\t'package.json: engines.node must be a string if present',\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tconst range: string = nodeEngine || DEFAULT_NODE; // Keep old default for compatiblity\n\n\t\t\t\treturn versionCache.get(bundle.deviceType).then(versions => {\n\t\t\t\t\tconst nodeVersion = semver.maxSatisfying(versions, range);\n\n\t\t\t\t\tif (nodeVersion == null) {\n\t\t\t\t\t\tthrow new Error(`Couldn't satisfy node version ${range}`);\n\t\t\t\t\t}\n\n\t\t\t\t\tlet dockerfile: string;\n\t\t\t\t\tif (this.hasScripts) {\n\t\t\t\t\t\tdockerfile = `\n\t\t\t\t\t\tFROM resin/${bundle.deviceType}-node:${nodeVersion}\n\t\t\t\t\t\tRUN mkdir -p /usr/src/app && ln -s /usr/src/app /app\n\t\t\t\t\t\tWORKDIR /usr/src/app\n\t\t\t\t\t\tCOPY . /usr/src/app\n\t\t\t\t\t\tRUN DEBIAN_FRONTEND=noninteractive JOBS=MAX npm install --unsafe-perm\n\t\t\t\t\t\tCMD [ \"npm\", \"start\" ]\n\t\t\t\t\t\t`;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tdockerfile = `\n\t\t\t\t\t\tFROM resin/${bundle.deviceType}-node:${nodeVersion}-onbuild\n\t\t\t\t\t\tRUN ln -s /usr/src/app /app\n\t\t\t\t\t`;\n\t\t\t\t\t}\n\t\t\t\t\tconst file: FileInfo = {\n\t\t\t\t\t\tname: 'Dockerfile',\n\t\t\t\t\t\tsize: dockerfile.length,\n\t\t\t\t\t\tcontents: new Buffer(dockerfile),\n\t\t\t\t\t};\n\t\t\t\t\treturn [file];\n\t\t\t\t});\n\t\t\t});\n\t}\n}\n"],"sourceRoot":"../src"}